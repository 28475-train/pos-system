<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>商品管理</title>
<link rel="stylesheet" href="style.css">
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script src="app.js"></script>
<script src="admin.js"></script>

<style>
.list-item {
    padding:10px;
    border-bottom:1px solid #ddd;
    display:flex;
    justify-content:space-between;
}
input { padding:8px; width:200px; }
button { padding:8px 15px; }
</style>
</head>

<body>

<h1>商品管理</h1>

<button onclick="openBarcodeReader()">バーコード読み取り</button>

<div id="scanArea" style="display:none;">
    <video id="camera" width="300" height="200" autoplay></video>
    <p id="scanResult"></p>
    <button onclick="closeBarcodeReader()">閉じる</button>
</div>

<h3>商品追加</h3>
コード：<input id="p_code"><br>
名前：<input id="p_name"><br>
価格：<input id="p_price"><br><br>
<button onclick="addProduct()">追加</button>

<h2>商品一覧</h2>
<div id="pList"></div>

<script>
let codeReader;
function loadProducts() {
    fetch(API + "?mode=getProducts")
        .then(r => r.json())
        .then(list => {
            let html = "";
            list.forEach(p => {
                html += `
                <div class="list-item">
                    <span>${p.code}：${p.name}（${p.price}円）</span>
                    <button onclick="deleteProduct('${p.code}')">削除</button>
                </div>
                `;
            });
            document.getElementById("pList").innerHTML = html;
        });
}
loadProducts();

function addProduct() {
    const code = document.getElementById("p_code").value;
    const name = document.getElementById("p_name").value;
    const price = document.getElementById("p_price").value;

    fetch(API, {
        method:"POST",
        body:JSON.stringify({ mode:"addProduct", code, name, price })
    })
    .then(r=>r.text())
    .then(()=>{
        alert("追加しました");
        loadProducts();
    });
}

function deleteProduct(code) {
    if (!confirm("削除しますか?")) return;

    fetch(API + "?mode=deleteProduct&code=" + code)
        .then(r=>r.text())
        .then(()=>loadProducts());
}

// ◆ バーコード読み取り
function openBarcodeReader(){
    document.getElementById("scanArea").style.display="block";
    codeReader = new ZXing.BrowserMultiFormatReader();
    codeReader.listVideoInputDevices().then(devices=>{
        const id=devices[0].deviceId;
        codeReader.decodeFromVideoDevice(id,'camera',(res,err)=>{
            if(res){
                document.getElementById("scanResult").textContent="読み取り："+res.text;
                document.getElementById("p_code").value=res.text;
                closeBarcodeReader();
            }
        });
    });
}

function closeBarcodeReader(){
    document.getElementById("scanArea").style.display="none";
    if(codeReader) codeReader.reset();
}
</script>

</body>
</html>
